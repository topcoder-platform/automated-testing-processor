version: 2
defaults: &defaults
  docker:
    - image: cimg/node:18.3.0

install_dependency: &install_dependency
  name: Installation of build dependencies.
  command: |
    sed -i '/jessie-updates/d' /etc/apt/sources.list
    apt update
    apt install -y openssl git zip jq 
    mkdir ~/awscli
    cd  ~/awscli
    curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
    unzip awscli-bundle.zip
    ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws

install_deploysuite: &install_deploysuite
  name: Installation of install_deploysuite.
  command: |
    git clone --branch v1.4 https://github.com/topcoder-platform/tc-deploy-scripts ../buildscript
    cp ./../buildscript/master_deploy.sh .
    cp ./../buildscript/buildenv.sh .
    cp ./../buildscript/awsconfiguration.sh .

build_steps: &build_steps # Initialization.
  - run: *install_dependency
  - checkout
  - run: *install_deploysuite
  - run:
      name: "AWS Configuration"
      command: |
        ./awsconfiguration.sh $BUILD_ENV
        source awsenvconf
  - run:
      name: Copy environment variables and scripts
      command: |
        source awsenvconf
        ./build-properties.sh -e $BUILD_ENV -k $APP_NAME
  - run:
      name: Build Pacakge
      command: ./build-package.sh $BUILD_ENV
  - run:
      name: "Deploy Automated Testing Processor"
      command: |
        source awsenvconf
        ./deploy.sh $BUILD_ENV $VER
jobs:
  # Build & Deploy against development backend
  "build-dev":
    <<: *defaults
    environment:
      APP_NAME: "automated-testing-processor"
      BUILD_ENV: "DEV"
    steps: *build_steps
  "build-prod":
    <<: *defaults
    environment:
      APP_NAME: "automated-testing-processor"
      BUILD_ENV: "PROD"
    steps: *build_steps

workflows:
  version: 2
  build:
    jobs:
      - build-dev:
          context: org-global
          filters:
            branches:
              only: [dev, feat/ci]
      - build-prod:
          context: org-global
          filters:
            branches:
              only: master
